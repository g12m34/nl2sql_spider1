// Malloy semantic layer for: department_management
// Full layer with ALL columns, primary keys, and bidirectional joins
// Database: /workspace/spider_db/spider/database/department_management/department_management.sqlite

// ============================================================
// BASE SOURCES (no joins - enables forward references)
// ============================================================

// department
source: department_base is duckdb.sql("""
  SELECT * FROM sqlite_scan('/workspace/spider_db/spider/database/department_management/department_management.sqlite', 'department')
""") extend {
  dimension:
    department_i_d is Department_ID
    name_val is `Name`

  primary_key: department_i_d

  measure:
    row_count is count()
    total_department_i_d is sum(department_i_d)
    avg_department_i_d is avg(department_i_d)
    max_department_i_d is max(department_i_d)
    min_department_i_d is min(department_i_d)
    total_ranking is sum(Ranking)
    avg_ranking is avg(Ranking)
    max_ranking is max(Ranking)
    min_ranking is min(Ranking)
    total_budget_in_billions is sum(Budget_in_Billions)
    avg_budget_in_billions is avg(Budget_in_Billions)
    max_budget_in_billions is max(Budget_in_Billions)
    min_budget_in_billions is min(Budget_in_Billions)
    total_num_employees is sum(Num_Employees)
    avg_num_employees is avg(Num_Employees)
    max_num_employees is max(Num_Employees)
    min_num_employees is min(Num_Employees)
}

// head
source: head_base is duckdb.sql("""
  SELECT * FROM sqlite_scan('/workspace/spider_db/spider/database/department_management/department_management.sqlite', 'head')
""") extend {
  dimension:
    head_i_d is head_ID
    name_val is `name`

  primary_key: head_i_d

  measure:
    row_count is count()
    total_head_i_d is sum(head_i_d)
    avg_head_i_d is avg(head_i_d)
    max_head_i_d is max(head_i_d)
    min_head_i_d is min(head_i_d)
    total_age is sum(age)
    avg_age is avg(age)
    max_age is max(age)
    min_age is min(age)
}

// management
source: management_base is duckdb.sql("""
  SELECT * FROM sqlite_scan('/workspace/spider_db/spider/database/department_management/department_management.sqlite', 'management')
""") extend {
  dimension:
    department_i_d is department_ID
    head_i_d is head_ID

  primary_key: department_i_d

  measure:
    row_count is count()
    total_department_i_d is sum(department_i_d)
    avg_department_i_d is avg(department_i_d)
    max_department_i_d is max(department_i_d)
    min_department_i_d is min(department_i_d)
    total_head_i_d is sum(head_i_d)
    avg_head_i_d is avg(head_i_d)
    max_head_i_d is max(head_i_d)
    min_head_i_d is min(head_i_d)
}

// ============================================================
// FULL SOURCES (with joins - use these for queries)
// ============================================================

// department (with joins)
source: department is department_base extend {
  join_many: management is management_base on department_i_d = management.department_i_d
}

// head (with joins)
source: head is head_base extend {
  join_many: management is management_base on head_i_d = management.head_i_d
}

// management (with joins)
source: management is management_base extend {
  join_one: head is head_base on head_i_d = head.head_i_d
  join_one: department is department_base on department_i_d = department.department_i_d
}
